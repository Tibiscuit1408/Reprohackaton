process cutadapt {
    input:
    path reads

    output:
    path "${reads.simpleName}_trimmed.fastq.gz"

    script:
    """
    cutadapt -m 25 -a TCAAGCAGAAGACGGCATACGAGATTACAAGGTGACTGGAGTTCAGACG \
        -o ${reads.simpleName}_trimmed.fastq.gz ${reads}
    """
}

process bowtie_build {
    input:
    path fasta

    output:
    path "Staphylococus.*"

    script:
    """
    bowtie-build ${fasta} Staphylococus
    """
}

process bowtie {
    input:
    path trimmed
    path index_files

    output:
    path "${trimmed.simpleName}_mapped.sam"

    script:
    """
    bowtie -x Staphylococus ${trimmed} -S ${trimmed.simpleName}_mapped.sam
    """
}

process featurescount {
    input:
    path sam
    path gtf

    output:
    path "${sam.simpleName}_gene_counts.txt"

    script:
    """
    featureCounts -a ${gtf} -o ${sam.simpleName}_gene_counts.txt -g gene_id -t CDS -s 1 ${sam}
    """
}

workflow {
    reads_ch = Channel.fromPath('Test_head.fastq.zip')
    fasta_ch = Channel.fromPath('reference_genome_Staphylococcus_aureus.fasta')
    gtf_ch   = Channel.fromPath('reference_genome_S_aureus.gtf')

    trimmed_ch = cutadapt(reads_ch)
    index_ch   = bowtie_build(fasta_ch)

    sam_ch = bowtie(trimmed_ch, index_ch)
    featurescount(sam_ch, gtf_ch)
}

